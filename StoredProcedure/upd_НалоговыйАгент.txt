CREATE PROCEDURE upd_НалоговыйАгент
@ID INT,
@Наимен_организации VARCHAR(100),
@Страна VARCHAR(100),
@Вид_дохода VARCHAR(150),
@Дата_платежа DATETIME,
@Сумма_платежа MONEY,
@Сумма_затрат_для_налога MONEY,
@Сумма_освоб_от_налога_РБ MONEY,
@Сумма_освоб_от_налога_международн MONEY,
@Ставка_налога_РБ SMALLINT,
@Ставка_налога_международн INT,
@Номер_ПлатежныйДок VARCHAR(20),
@Дата_ПлатежныйДок DATETIME,
@Сумма_ПлатежныйДок MONEY,
@ID_платежный_док INT
AS
DECLARE @docID INT, @docIDold INT
IF (@ID_платежный_док IS NULL) AND (@Номер_ПлатежныйДок <> '') AND (@Сумма_ПлатежныйДок IS NOT NULL)
	BEGIN
		EXECUTE add_ПлатежныйДокумент @Номер_ПлатежныйДок, @Дата_ПлатежныйДок, @Сумма_ПлатежныйДок, @docID output
	END

IF (@ID_платежный_док IS NOT NULL) AND (@Номер_ПлатежныйДок <> '') AND (@Сумма_ПлатежныйДок IS NOT NULL)
	BEGIN
		EXECUTE upd_Платежный_Док @Номер_ПлатежныйДок, @Дата_ПлатежныйДок, @Сумма_ПлатежныйДок, @ID_платежный_док
		SET @docID = @ID_платежный_док
	END
	
SET @docIDold = (SELECT Налоговый_агент.ID_платежный_док FROM Налоговый_агент WHERE Налоговый_агент.ID = @ID) 

IF (@Номер_ПлатежныйДок = '') AND (@docIDold IS NOT NULL)
	BEGIN
		UPDATE Платежный_документ SET DEL = 1 WHERE ID_платежный_док = @docIDold
		SET @docID = NULL
	END

UPDATE Налоговый_агент SET ID_платежный_док = @docID, Наимен_организации = @Наимен_организации, Страна = @Страна, Вид_дохода = @Вид_дохода, 
Дата_платежа = @Дата_платежа, Сумма_платежа = @Сумма_платежа, Сумма_затрат_для_налога = @Сумма_затрат_для_налога, Сумма_освоб_от_налога_РБ = @Сумма_освоб_от_налога_РБ,
Сумма_освоб_от_налога_международн = @Сумма_освоб_от_налога_международн, Ставка_налога_РБ = @Ставка_налога_РБ, Ставка_налога_международн = @Ставка_налога_международн
WHERE ID = @ID